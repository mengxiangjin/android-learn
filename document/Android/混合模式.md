### 混合模式

#### PorterDuffXfermode

#####  paint.xfermode = PorterDuffXfermode(PorterDuff.Mode.ADD)

目标图像：红色圆

源图像：蓝色矩形

```kotlin
private fun initSrcBitmap() {
    srcBitmap = Bitmap.createBitmap(bitmapWidth.toInt(), bitmapHeight.toInt(), Bitmap.Config.ARGB_8888)
    val canvas = Canvas(srcBitmap!!)
    paint.color = Color.BLUE
    canvas.drawRect(0f,0f,bitmapWidth,bitmapHeight,paint)
}

private fun initDstBitmap() {
    dstBitmap = Bitmap.createBitmap(bitmapWidth.toInt(), bitmapHeight.toInt(), Bitmap.Config.ARGB_8888)
    val canvas = Canvas(dstBitmap!!)
    paint.color = Color.RED
    canvas.drawOval(0f,0f,bitmapWidth,bitmapHeight,paint)
}

override fun onDraw(canvas: Canvas) {
    super.onDraw(canvas)
    val saveLayerID = canvas.saveLayer(0f, 0f, width.toFloat(), height.toFloat(), null)
    canvas.drawBitmap(dstBitmap!!,0f,0f,paint)

    //xfermode设置前为目标对象，即给谁应用xfermode
    paint.xfermode = PorterDuffXfermode(PorterDuff.Mode.ADD)

    //xfermode设置后为源对象，拿什么应用xfermode
    canvas.drawBitmap(srcBitmap!!,bitmapWidth / 2f,bitmapHeight / 2f,paint)
    paint.xfermode = null
    canvas.restoreToCount(saveLayerID)
}
```

##### PorterDuff.Mode.ADD

- 目标图像（红）与源图像每个像素饱和度相加
- 相交区域饱和度为增加后的值
- 相交处饱和度颜色值相加，未相交处即保持原样（一方饱和度为0）

![微信图片_20240125163615](https://s2.loli.net/2024/01/25/X4o9VRpn1yrOB8W.jpg)

##### PorterDuff.Mode.LIGHTEN

- 相交区域变亮

![微信图片_20240125163615](https://s2.loli.net/2024/01/25/X4o9VRpn1yrOB8W.jpg)

##### PorterDuff.Mode.DARKEN

- 相交区域变暗

![2edd879d1714b1cbac06734e8e408ff](https://s2.loli.net/2024/01/25/NqkoHmbLdYVIXgE.jpg)

##### PorterDuff.Mode.MULTIPLY

- 颜色相乘，透明度相乘
- 源图非相交区域透明度 *（目标图像在此区域透明度为0） = 0，源图像非相交区域透明度=0

![be98ba206160e83d19346d3d343632a](https://s2.loli.net/2024/01/25/KeSCt2IPGiOfjaQ.jpg)

##### PorterDuff.Mode.OVERLAY

![a90442e344b7ec4452eb5397c1159c2](https://s2.loli.net/2024/01/25/VAH7IFdJn3LwTU4.jpg)

##### PorterDuff.Mode.SCREEN

![ad5110444edda5e7668f1e72a3f64da](https://s2.loli.net/2024/01/25/GCRrepUANEkDoJI.jpg)

##### 以源图像显示为主的模式

##### PorterDuff.Mode.SRC

- 源图像显示为主

![a70196cec7039bd3bfc85fa6c12b6db](https://s2.loli.net/2024/01/25/UexAi4vREnoOKVp.jpg)

##### PorterDuff.Mode.SRC_IN

- [源图像透明度 * 目标图像透明度，源图像颜色* 目标图像透明度]
- 非相交区域，目标图像在源图像位置处透明度0，故源图像非相交区域透明

![3bb6b7355af83aefd0acfdf24c2c09e](https://s2.loli.net/2024/01/25/dhJM87osfSYHl3v.jpg)

##### 绘制圆角图片

- 利用**PorterDuff.Mode.SRC_IN** 相交特性
- 图片为源图像，圆角框为目标头像
- 圆角框大小与图片相同
- 设置xfermode属性后绘制，即图片非相交区域变透明实现圆角效果

```kotlin
srcBitmap = BitmapFactory.decodeResource(resources, R.drawable.girl)
dstBitmap = Bitmap.createBitmap(srcBitmap!!.width, srcBitmap!!.height, Bitmap.Config.ARGB_8888)
val canvas = Canvas(dstBitmap!!)
paint.color = Color.WHITE
canvas.drawRoundRect(0f,0f,srcBitmap!!.width.toFloat(),srcBitmap!!.height.toFloat(),20f,20f,paint)
canvas.drawBitmap(dstBitmap!!,0f,0f,paint)
paint.xfermode = PorterDuffXfermode(PorterDuff.Mode.SRC_IN)
canvas.drawBitmap(srcBitmap!!,0f,0f,paint)
```

![9c42ccd88829cbb036bb8f9c1f6c5ad](https://s2.loli.net/2024/01/25/OoHptqPBS5G9IN3.jpg)

##### 图像的倒影效果

- 利用**PorterDuff.Mode.SRC_IN** 特性 透明度相互乘积特性
- 源图像，复制一个倒立的图像，复制图像绘制在原图像下方，白色遮罩作为目标图像同复制图像位置一样
- 将复制图像作为源图像，白色遮罩层（从上到下为透明度50%->0）作为目标图像，设置**PorterDuff.Mode.SRC_IN**，相交区域透明度会相交，实现倒影
- 为何下方为偏移srcBitmap.height * 2f ？setScale(1f,-1f) 会

```kotlin
private fun invertedExample(canvas: Canvas) {
    //绘制原图像
    val srcBitmap = BitmapFactory.decodeResource(resources,R.drawable.girl)
    canvas.drawBitmap(srcBitmap,0f,0f,paint)

    val saveLayerID = canvas.saveLayer(0f, 0f, width.toFloat(), height.toFloat(), null)

    //源图像下方绘制遮罩作为目标图像
    val dstBitmap = BitmapFactory.decodeResource(resources,R.drawable.shader)
    canvas.drawBitmap(dstBitmap,0f,srcBitmap!!.height.toFloat(),paint)

    paint.xfermode = PorterDuffXfermode(PorterDuff.Mode.SRC_IN)

    //绘制倒过来的原图像（作为源图像） PorterDuff.Mode.SRC_IN应用此源图像
    val newMatrix = Matrix()
    newMatrix.setScale(1f,-1f)
    newMatrix.postTranslate(0f,srcBitmap.height * 2f)
    canvas.drawBitmap(srcBitmap,newMatrix,paint)

    paint.xfermode = null
    canvas.restoreToCount(saveLayerID)
}
```

![0dd87b9e63559307cf76f277111a9aa](https://s2.loli.net/2024/01/26/1QTcYGsHPCox492.jpg)

##### PorterDuff.Mode.SRC_OUT

- 目标图像的补集作为源图像的透明度、颜色
- 目标图像在该像素点有图像时显示目标图像，没有图像时显示源图像
- 相交区域，目标图像透明度100，取补集即为0，故源图像相交区域为空白像素。源图像未相交区域，目标图像透明度为0，补集即为100，故源图像未相交区域完全展示

![3c61971e8c2e69e72d244a8be493c07](https://s2.loli.net/2024/01/26/ntIlrGuJ67isNUY.jpg)

##### 橡皮擦效果

- **SRC_OUT**属性源图像与目标图像相交区域会变空白像素
- 绘制源图像，创建新的空白目标图像同源图像相同大小
- 根据手指移动的**Path**绘制在目标图像上
- 设置**PorterDuff.Mode.SRC_OUT**绘制源图像即可
- 相交区域变空白像素达到效果

```kotlin
private fun eraserExample(canvas: Canvas) {
    paint.strokeWidth = 30f
    val saveLayerID = canvas.saveLayer(0f, 0f, width.toFloat(), height.toFloat(), paint)

    val bitmapCanvas = Canvas(eraserDstBitmap!!)
	//path绘制到目标图像上，导致目标图像与源图像相交，源图像相交处空白
    bitmapCanvas.drawPath(path,paint)
    canvas.drawBitmap(eraserDstBitmap!!,0f,0f,paint)
    paint.xfermode = PorterDuffXfermode(PorterDuff.Mode.SRC_OUT)
    canvas.drawBitmap(eraserSrcBitmap!!,0f,0f,paint)
    paint.xfermode = null
    canvas.restoreToCount(saveLayerID)
}
```

![tutieshi_640x1422_12s (1)](https://s2.loli.net/2024/01/26/31FgODqov9rpJQw.gif)

##### 刮刮乐效果

- **SRC_OUT**属性源图像与目标图像相交区域会变空白像素
- 绘制出中奖图片（最底层）
- 绘制手势路径
- 设置**PorterDuff.Mode.SRC_OUT**绘制源图像即蒙层
- 手势路径（目标图像）与蒙层（源图像）相交会导致区域变空白，露出最底层中奖图片

```kotlin
eraserSrcBitmap = BitmapFactory.decodeResource(resources, R.drawable.girl)
eraserDstBitmap =
    Bitmap.createBitmap(eraserSrcBitmap!!.width, eraserSrcBitmap!!.height, Bitmap.Config.ARGB_8888)
bonusBitmap =
    BitmapFactory.decodeResource(resources, R.drawable.avatar)

//将中奖图片缩放到与遮罩图相同大小
bouncedMatrix.setScale(eraserSrcBitmap!!.width / 1f / bonusBitmap!!.width,eraserSrcBitmap!!.height / 1f / bonusBitmap!!.height)
```

```kotlin
private fun eraserExample(canvas: Canvas) {
    paint.strokeWidth = 30f
    
    //绘制奖励图片（最底层）
    canvas.drawBitmap(bonusBitmap!!,bouncedMatrix,paint)
    val saveLayerID = canvas.saveLayer(0f, 0f, width.toFloat(), height.toFloat(), paint)

    val bitmapCanvas = Canvas(eraserDstBitmap!!)
    paint.style = Paint.Style.STROKE

    bitmapCanvas.drawPath(path,paint)
    canvas.drawBitmap(eraserDstBitmap!!,0f,0f,paint)
    paint.xfermode = PorterDuffXfermode(PorterDuff.Mode.SRC_OUT)
    canvas.drawBitmap(eraserSrcBitmap!!,0f,0f,paint)

    paint.xfermode = null
    canvas.restoreToCount(saveLayerID)
}
```

![tutieshi_576x1280_13s](https://s2.loli.net/2024/01/26/cpJQ6XHmvNqgAZ8.gif)
